\NeedsTeXFormat{LaTeX2e}
\RequirePackage[top=0.5in, bottom=0.5in, left=2in, right=1in,%
                footskip=0.2in,headsep=10pt
                %,showframe
                ]{geometry}
\usepackage[columns=3]{idxlayout}
\EnableCrossrefs
\CodelineIndex
\RecordChanges
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\RequirePackage{microtype,lmodern,libertine,fetamont,hologo}
\RequirePackage[semibold,scale=0.90]{sourcecodepro}
\RequirePackage[semibold,osf,scale=0.90]{sourcesanspro}
%\DisableLigatures[f]{encoding = *, family = tt* }
\RequirePackage{xspace,titlesec,enumitem,fancyhdr,lastpage}
\usepackage[titles]{tocloft}
\RequirePackage[dvipsnames]{xcolor}
\RequirePackage{adjustbox,multicol,hyperref,xparse,listings}
\usepackage{interfaces,graphicx}

% \parindent
\setlength{\parindent}{0pt}

% Colors for options
\definecolor{optcolor}{rgb}{0.281,0.275,0.485}

% \LTXimg Logo whit libertine font
\newsavebox{\logobox}
\savebox{\logobox}{%
    \normalsize%
    {\libertineInitial%
     \textcolor{red}{L}\hspace{-3.0pt}%
     \raisebox{-0.2em}{\small \textcolor{green}{T}}%
     \hspace{-2.9pt}\textcolor{blue}{X}}%
     \hspace{-1pt}\textffmw{\textcolor{gray}{img}}%
}% close box
\newcommand{\LTXimg}{%
  \settoheight{\@tempdima}{L}%
  \resizebox{!}{\@tempdima}{\usebox{\logobox}}%
}
% oldstyle for libertine
\useosf

% Configuration for section
\titleformat{\section}[hang]
    {\normalfont\large\bfseries}
    {\thesection}{0.5em}{}

% Config hyperref
\hypersetup{
  linkcolor  = blue!50,
  citecolor  = red,
  urlcolor   = cyan,
  colorlinks = true,%
  pdftitle   =.::ltximg v1.5 (2017-29-12)::. extract and convert environments to image formats,%
  pdfauthor= {Pablo González Luengo},%
  pdfsubject={script extract manual},%
  pdfstartview={FitH},%  
  bookmarksopenlevel=2,%
}

% Configuration fancyhdr
\fancypagestyle{plain}{%
\fancyhf{}%
\fancyfoot[C]{%
    \textsf{\thepage}\ of \textsf{\pageref{LastPage}}
    }%
\renewcommand{\headrulewidth}{0pt}%
\renewcommand{\footrulewidth}{0pt}%
}%

\renewcommand{\sectionmark}[1]{
    \markboth{\textsf{\scshape\small\S\thesection. #1}}{}
    }%

\fancypagestyle{myheader}{%
\fancyhf{}%
\fancyhead[L]{\raisebox{-0.75\baselineskip}[0pt][0pt]{%
    \textsf{\small\LTXimg{} \textcolor{gray}{v1.5}}%
        }%
    }%
\fancyhead[RO,CE]{\raisebox{-0.75\baselineskip}[0pt][0pt]{%
    \small\nouppercase{\leftmark}%
        }%
    }%
\fancyfoot[C]{\textsf{\thepage}\ of \textsf{\pageref{LastPage}}}%
\renewcommand{\headrulewidth}{0.5pt}%
\renewcommand{\footrulewidth}{0.5pt}%
\renewcommand{\headrule}{%
    \hbox to\headwidth{%
    \color{optcolor}\leaders\hrule height \headrulewidth\hfill}%
    }%
\renewcommand{\footrule}{%
    \hbox to\headwidth{%
    \color{optcolor}\leaders\hrule height \footrulewidth\hfill}%
    }%
}
\setlength{\headheight}{21pt}%

%% Custom <meta> and more
\ExplSyntaxOn
%^^A user level commands
\RenewDocumentCommand{\meta}{O{}m}
{
    \ltximg_meta_generic:Nnn \ltximg_meta:n { #1 } { #2 }
}
\RenewDocumentCommand{\marg}{O{}m}
{
    \ltximg_meta_generic:Nnn \ltximg_marg:n { #1 } { #2 }
}
\RenewDocumentCommand{\oarg}{O{}m}
{
    \ltximg_meta_generic:Nnn \ltximg_oarg:n { #1 } { #2 }
}
%^^A variables and keys
\tl_new:N \l_ltximg_meta_font_tl

\keys_define:nn { ltximg/meta }
{
    type .choice:,
    type / tt .code:n = \tl_set:Nn \l_ltximg_meta_font_tl { \ttfamily },
    type / rm .code:n = \tl_set:Nn \l_ltximg_meta_font_tl { \rmfamily },
    type .initial:n = tt,
    cf .tl_set:N = \l_ltximg_meta_color_tl,
    cf .initial:n = black,
    ac .tl_set:N = \l_ltximg_meta_anglecolor_tl,
    ac .initial:n = black,
    sbc .tl_set:N = \l_ltximg_meta_brackcolor_tl,
    sbc .initial:n = black,
    cbc .tl_set:N = \l_ltximg_meta_bracecolor_tl,
    cbc .initial:n = black,
}
%^^A internal commands
\cs_new_protected:Npn \ltximg_meta_generic:Nnn #1 #2 #3
{
    \group_begin:
    \keys_set:nn { ltximg/meta } { #2 }
    \color{ \l_ltximg_meta_color_tl }
    \l_ltximg_meta_font_tl
    #1 { #3 } % #1 is \ltximg_meta:n, \ltximg_marg:n or \ltximg_oarg:n
    \group_end:
}
\cs_new_protected:Npn \ltximg_meta:n #1
{
    \ltximg_meta_angle:n { \textlangle }
    \ltximg_meta_meta:n { #1 }
    \ltximg_meta_angle:n { \textrangle }
}
\cs_new_protected:Npn \ltximg_marg:n #1
{
    \ltximg_meta_brace:n { \textbraceleft }
    \ltximg_meta:n { #1 }
    \ltximg_meta_brace:n { \textbraceright }
}
\cs_new_protected:Npn \ltximg_oarg:n #1
{
    \ltximg_meta_brack:n { [ }
    \ltximg_meta:n { #1 }
    \ltximg_meta_brack:n { ] }
}
\cs_new_protected:Npn \ltximg_meta_meta:n #1
{
    \textnormal{\textit{#1}}
}
\cs_new_protected:Npn \ltximg_meta_angle:n #1
{
    \group_begin:
    \fontfamily{cmr}\selectfont
    \textcolor{\l_ltximg_meta_anglecolor_tl}{#1}
    \group_end:
}
\cs_new_protected:Npn \ltximg_meta_brace:n #1
{
    \group_begin:
    \color{\l_ltximg_meta_bracecolor_tl}
    #1
    \group_end:
}
\cs_new_protected:Npn \ltximg_meta_brack:n #1
{
    \textcolor{\l_ltximg_meta_brackcolor_tl}{#1}
}
\ExplSyntaxOff

%% pkgname
\DeclareDocumentCommand\pkgname{m}{%
    \mbox{\textsf{#1}}%
    \SortIndex{packages}{packages>\textsf{#1}}%
    %\SortIndex{#1}{\textsf{#1} (package)}%
}%

%% package options
\DeclareDocumentCommand\pkgopt{m}{%
    \mbox{\textsf{#1}}%
    \SortIndex{package options}{package options>\textsf{#1}}%
    \SortIndex{#1}{\textsf{#1} (package option)}%
}%

%% program name
\DeclareDocumentCommand\prgname{sm}{%
    \IfBooleanTF{#1}
    {
    \mbox{\textcolor{gray}{\ttfamily\small\bfseries{#2}}\xspace}%
    \SortIndex{compiler}{compiler>\textsf{#2}}%
    }
    {
    \mbox{\textsf{#2}\xspace}%
    \SortIndex{programs}{programs>\textsf{#2}}%
    }
}%

%% program options
\DeclareDocumentCommand\prgopt{sm}{%
    \IfBooleanTF{#1}
    {
    \mbox{\textcolor{gray}{\ttfamily\small\bfseries{-{}#2}}\xspace}%
    \SortIndex{compiler options}{compiler options>\texttt{-{}#2}}%
    }
    {
    \mbox{\texttt{-{}#2}}%
    \SortIndex{#2}{\texttt{-{}#2} (program option)}%
    }
}

%% script name
\DeclareDocumentCommand\scriptname{m}{%
    \mbox{\textsf{#1}}%
    \SortIndex{scripts}{scripts>\textsf{#1}}%
}%

%% script options
\DeclareDocumentCommand\scriptopt{m}{%
    \mbox{\texttt{#1}}\xspace%
    \SortIndex{script option}{script options>\small\textsf{#1}}%
}

%% file extention
\DeclareDocumentCommand\fext{m}{%
    \mbox{\textcolor{gray}{\ttfamily\small\bfseries{.#1}}\xspace}%
    \SortIndex{files extention}{files extentions>\small\textsf{.#1}}%
}

%% image format exten
\DeclareDocumentCommand\iext{m}{%
    \mbox{\textcolor{optcolor}{\ttfamily\small\bfseries{#1}}\xspace}%
    \SortIndex{image format}{image formats>\small\textsf{#1}}%
}

%% \sysydir{m}
\DeclareDocumentCommand\sysdir{m}{%
    \mbox{\textcolor{gray}{\ttfamily\small\bfseries{/#1}}}%
}

%% \env{m}
\DeclareDocumentCommand\env{sm}{
    \textcolor{gray}{\ttfamily\small\bfseries{#2}}%
    \SortIndex{environment}{environments>\small\textsf{#2}}%
}

%% \cmdopt[short]{long}
\NewDocumentCommand\cmdopt{om}{%
    \IfNoValueTF{#1}%
    {\textcolor{optcolor}{\ttfamily\small\bfseries{-{}-#2}}\xspace}%
    {\textcolor{optcolor}{\ttfamily\small\bfseries{-{}#1}}, \textcolor{optcolor}{\ttfamily\small\bfseries{-{}-#2}}\xspace}%
\SortIndex{options}{\textsf{\myscript}\ options in command line>\small\texttt{-{}-#2}}%
}

%% \myenv{environ}
\DeclareDocumentCommand\myenv{m}{%
\moveright 0.0pt \hbox{%
    \begin{minipage}[t]{\marginparwidth}%
        \raggedleft\ttfamily%
        {\textcolor{gray}{\textbackslash begin\{}}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{\}}\par%
        \meta[ac=gray,cf=gray]{env content}\par%
        {\textcolor{gray}{\textbackslash end\{}}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{\}}%
    \end{minipage}%
                    } % close hbox
\SortIndex{environment}{environments>\small\textsf{#1}}%
}%

%% \mytag{dtxtag}
\DeclareDocumentCommand\mytag{m}{%
\moveright 0.0pt \hbox{%
    \begin{minipage}[t]{\marginparwidth}%
        \raggedleft\ttfamily%
        \textcolor{gray}{\%<*}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{>}\par%
        \meta[ac=gray,cf=gray]{content}\par%
        \textcolor{gray}{\%</}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{>}%
    \end{minipage}%
                    } % close hbox
\SortIndex{docstrip}{docstrip tag>\textsf{#1}}%
}%

%% tag/env suport in margin
\newsavebox{\marginenvtag}
\NewDocumentCommand\DescribeTE{sm}{%
\begin{lrbox}{\marginenvtag}%
   \begin{minipage}[t]{\marginparwidth}%
    \raggedleft
    \IfBooleanTF{#1}{\mytag{#2}}{\myenv{#2}}
    \end{minipage}%
\end{lrbox}%
    \leavevmode%
    \marginpar{\usebox{\marginenvtag}}%
    \ignorespaces%
}%

%% DescribeOptFile*{options}{example}[!]
\newsavebox{\optinfile}
\NewDocumentCommand\DescribeOptFile{s m m O{\hphantom{!}}}{
\begin{lrbox}{\optinfile}%
   \begin{minipage}[t]{\marginparwidth}%
        \raggedleft\ttfamily\bfseries%
        \textcolor{optcolor}{\%{#4}\myscript\hspace*{1.5pt}}%
    \end{minipage}%
\end{lrbox}%
\leavevmode%
\marginpar{\usebox{\optinfile}}%
\lapbox[0pt]{-0.85\marginparsep}{\textcolor{red}{\texttt{:}}}%
\textcolor{optcolor}{\bfseries\texttt{{#2}}}%
\textcolor{red}{\hspace*{2.5pt}\texttt{:}}
\hspace*{-1pt}\marg[cbc=optcolor,ac=gray,cf=gray]{#3}
\vspace*{2pt}\par%
\IfNoValueTF{#1}
{}%%
{%
\SortIndex{options}{\textsf{\myscript}\ options in input file>\small\texttt{#2}}%
}%
}

%% DescribeCmd[...]{...}{...}{...}
\newsavebox{\optcmdline}
\NewDocumentCommand\DescribeCmd{ommm}{
\begin{lrbox}{\optcmdline}%
   \begin{minipage}[t]{\marginparwidth}%
    \ttfamily\bfseries\raggedleft%
    \IfNoValueTF{#1}
    {\textcolor{optcolor}{-{}-#2}}
    {\textcolor{optcolor}{-{#1}}\textcolor{gray}{,} \textcolor{optcolor}{-{}-#2}}%
    \end{minipage}%
\SortIndex{options}{\textsf{\myscript}\ options in command line>\small\texttt{-{}-#2}}%
\end{lrbox}%
    \leavevmode%
    \marginpar{\usebox{\optcmdline}}%
    \ignorespaces
    \meta[ac=gray,cf=gray]{\textnormal{\sffamily{#3}}}
    \hfill\textcolor{gray}{\textsf{(default: {#4})}}%
    \vspace*{2pt}\par%
}

% Create a ltximg-doc language
\lstdefinelanguage{ltximg-doc}{
    texcsstyle=*,%
    frame=single,%
    rulecolor=\color{gray!50},%
    framesep=\fboxsep,%
    framerule=\fboxrule,%
    xleftmargin=\dimexpr\fboxsep+\fboxrule\relax,%
    xrightmargin=\dimexpr\fboxsep+\fboxrule\relax,%
    escapechar=§,%
    showstringspaces=false,%
% Important words
    classoffset=1,%
    keywordstyle=\color{blue!50},%
    keywords={usepackage,graphicspath,begin,end,documentclass,AtBeginDocument,%
    RequirePackage,renewcommand,PreviewBbAdjust},%
% Other words
    classoffset=2, %
    keywordstyle=\color{darkgray},%
    morekeywords={somepack,document,graphicx,preview,active,tightpage,article},%
% literateee
literate=*{\{}{{\textcolor{gray}{\{}}}{1}
          {\}}{{\textcolor{gray}{\}}}}{1}
          {[}{{\textcolor{gray}{[}}}{1}
          {]}{{\textcolor{gray}{]}}}{1}
          {/}{{\textcolor{gray}{/}}}{1}
}[keywords,tex,comments]% end languaje

% Define a style for iniline
\lstdefinestyle{inline}
{
    language=ltximg-doc,%
    basicstyle=\ttfamily\small\color{gray},%
% Reserved words (inputfile options)
    classoffset=3,%
    keywordstyle=\bfseries\color{optcolor},%
    morekeywords={ltximg,noltximg,remove,options,pspicture,endpspicture,%
    PSTexample,clean,pst,tkz,eps,pdf,pgfpicture, endpgfpicture,%
    tikzpicture, endtikzpicture, psgraph, endpsgraph,nopreview,postscript,%
    xetex,latex,luatex,dvips,arara,psset,extrenv},%
}

% Environment for code
\lstnewenvironment{examplecode}{%
\lstset{
    language=ltximg-doc,%
    basicstyle=\ttfamily\small\color{gray},%
% Reserved words (inputfile options)
    classoffset=3,%
    keywordstyle=\bfseries\color{optcolor},%
    morekeywords={ltximg,noltximg,remove,options,pspicture,endpspicture,%
    PSTexample,clean,pst,tkz,eps,pdf,pgfpicture, endpgfpicture,%
    tikzpicture, endtikzpicture, psgraph, endpsgraph,nopreview,postscript,%
    xetex,latex,luatex,dvips,arara,psset,extrenv},%
    }% close lstset
}%
{}% close examplecode

%%% Environment for code
\lstnewenvironment{examplecmd}{%
\lstset{
    language=ltximg-doc,%
    basicstyle=\ttfamily\small,%
%%% Reserved words (cmd line options)
    classoffset=4,%
    keywordstyle=\bfseries\color{optcolor},%
    morekeywords={ltximg},%
%%% Only for command line options
    classoffset=5,%
    keywordstyle=\color{blue},%
    keywords={user,machine},%
%%% literateee
literate=*{[}{{\textcolor{darkgray}{[}}}{1}
          {]}{{\textcolor{darkgray}{]}}}{1}
          {@}{{\textcolor{blue}{@}}}{1}
          {\$}{{\textcolor{blue}{\$}}}{1}
          {:}{{\textcolor{blue}{:}}}{1}
          {~}{{\textcolor{blue}{\bfseries\textasciitilde}}}{1}%
    }% close lstset {~}
}%
{}% close examplecmd

% Default languaje
\lstset{language=ltximg-doc}

\endinput
