\NeedsTeXFormat{LaTeX2e}
\RequirePackage[top=0.5in, bottom=0.5in, left=2in, right=1in,%
                footskip=0.2in,headsep=10pt
                %,showframe
                ]{geometry}
\usepackage[columns=2]{idxlayout}
\EnableCrossrefs
\CodelineIndex
\RecordChanges
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\RequirePackage{microtype,lmodern,libertine,fetamont,hologo}
\RequirePackage[semibold,scale=0.90]{sourcecodepro}
\RequirePackage[semibold,osf,scale=0.90]{sourcesanspro}
\RequirePackage{xspace,titlesec,enumitem,fancyhdr,lastpage}
\usepackage[titles]{tocloft}
\RequirePackage[dvipsnames,svgnames]{xcolor}
\RequirePackage{adjustbox,multicol,hyperref,xparse,listings}
\usepackage{interfaces,graphicx}
\RequirePackage{accsupp}
\newcommand*{\noaccsupp}[1]{\BeginAccSupp{ActualText={}}#1\EndAccSupp{}}

% parindent
\setlength{\parindent}{0pt}

% Colors for options
\definecolor{optcolor}{rgb}{0.281,0.275,0.485}
%\colorlet{mylinkcolor}{violet}
\colorlet{mycitecolor}{YellowOrange}
\colorlet{myurlcolor}{Aquamarine}

% \LTXimg Logo whit libertine font
\newsavebox{\logobox}
\savebox{\logobox}{%
    \normalsize%
    {\libertineInitial%
     \textcolor{red}{L}\hspace{-3.0pt}%
     \raisebox{-0.2em}{\small \textcolor{green}{T}}%
     \hspace{-2.9pt}\textcolor{blue}{X}}%
     \hspace{-1pt}\textffmw{\textcolor{gray}{img}}%
}% close box
\newcommand{\LTXimg}{%
  \settoheight{\@tempdima}{L}%
  \resizebox{!}{\@tempdima}{\usebox{\logobox}}%
}
% oldstyle for libertine
\useosf

% Configuration for section
\titleformat{\section}[hang]
    {\normalfont\large\bfseries}
    {\thesection}{0.5em}{}

% Config hyperref
\hypersetup{
  linkcolor  = blue!50,
  citecolor  = mycitecolor,%
  urlcolor   = magenta,%
% citecolor  = red,
% urlcolor   = magenta,
  colorlinks = true,%
  pdftitle   =.::ltximg v1.5 (2017-12-12)::. extract and convert environments to image formats,%
  pdfauthor= {Pablo González Luengo},%
  pdfsubject={Documentation for version 1.5},%
  pdfstartview={FitH},%  
  bookmarksopenlevel=2,%
}

% Configuration fancyhdr
\fancypagestyle{plain}{%
\fancyhf{}%
\fancyfoot[C]{%
    \textsf{\thepage}\ of \textsf{\pageref{LastPage}}
    }%
\renewcommand{\headrulewidth}{0pt}%
\renewcommand{\footrulewidth}{0pt}%
}%

\renewcommand{\sectionmark}[1]{
    \markboth{\textsf{\scshape\small\S\thesection. #1}}{}
    }%

\fancypagestyle{myheader}{%
\fancyhf{}%
\fancyhead[L]{\raisebox{-0.75\baselineskip}[0pt][0pt]{%
    \textsf{\small\LTXimg{} \textcolor{gray}{v1.5}}%
        }%
    }%
\fancyhead[RO,CE]{\raisebox{-0.75\baselineskip}[0pt][0pt]{%
    \small\nouppercase{\leftmark}%
        }%
    }%
\fancyfoot[C]{\textsf{\thepage}\ of \textsf{\pageref{LastPage}}}%
\renewcommand{\headrulewidth}{0.5pt}%
\renewcommand{\footrulewidth}{0.5pt}%
\renewcommand{\headrule}{%
    \hbox to\headwidth{%
    \color{optcolor}\leaders\hrule height \headrulewidth\hfill}%
    }%
\renewcommand{\footrule}{%
    \hbox to\headwidth{%
    \color{optcolor}\leaders\hrule height \footrulewidth\hfill}%
    }%
}
\setlength{\headheight}{21pt}%

% Custom <meta> and more
\ExplSyntaxOn
%^^A user level commands
\RenewDocumentCommand{\meta}{O{}m}
{
    \ltximg_meta_generic:Nnn \ltximg_meta:n { #1 } { #2 }
}
\RenewDocumentCommand{\marg}{O{}m}
{
    \ltximg_meta_generic:Nnn \ltximg_marg:n { #1 } { #2 }
}
\RenewDocumentCommand{\oarg}{O{}m}
{
    \ltximg_meta_generic:Nnn \ltximg_oarg:n { #1 } { #2 }
}
%^^A variables and keys
\tl_new:N \l_ltximg_meta_font_tl

\keys_define:nn { ltximg/meta }
{
    type .choice:,
    type / tt .code:n = \tl_set:Nn \l_ltximg_meta_font_tl { \ttfamily },
    type / rm .code:n = \tl_set:Nn \l_ltximg_meta_font_tl { \rmfamily },
    type .initial:n = tt,
    cf .tl_set:N = \l_ltximg_meta_color_tl,
    cf .initial:n = black,
    ac .tl_set:N = \l_ltximg_meta_anglecolor_tl,
    ac .initial:n = black,
    sbc .tl_set:N = \l_ltximg_meta_brackcolor_tl,
    sbc .initial:n = black,
    cbc .tl_set:N = \l_ltximg_meta_bracecolor_tl,
    cbc .initial:n = black,
}
%^^A internal commands
\cs_new_protected:Npn \ltximg_meta_generic:Nnn #1 #2 #3
{
    \group_begin:
    \keys_set:nn { ltximg/meta } { #2 }
    \color{ \l_ltximg_meta_color_tl }
    \l_ltximg_meta_font_tl
    #1 { #3 } % #1 is \ltximg_meta:n, \ltximg_marg:n or \ltximg_oarg:n
    \group_end:
}
\cs_new_protected:Npn \ltximg_meta:n #1
{
    \ltximg_meta_angle:n { \textlangle }
    \ltximg_meta_meta:n { #1 }
    \ltximg_meta_angle:n { \textrangle }
}
\cs_new_protected:Npn \ltximg_marg:n #1
{
    \ltximg_meta_brace:n { \textbraceleft }
    \ltximg_meta:n { #1 }
    \ltximg_meta_brace:n { \textbraceright }
}
\cs_new_protected:Npn \ltximg_oarg:n #1
{
    \ltximg_meta_brack:n { [ }
    \ltximg_meta:n { #1 }
    \ltximg_meta_brack:n { ] }
}
\cs_new_protected:Npn \ltximg_meta_meta:n #1
{
    \textnormal{\textit{#1}}
}
\cs_new_protected:Npn \ltximg_meta_angle:n #1
{
    \group_begin:
    \fontfamily{cmr}\selectfont
    \textcolor{\l_ltximg_meta_anglecolor_tl}{#1}
    \group_end:
}
\cs_new_protected:Npn \ltximg_meta_brace:n #1
{
    \group_begin:
    \color{\l_ltximg_meta_bracecolor_tl}
    #1
    \group_end:
}
\cs_new_protected:Npn \ltximg_meta_brack:n #1
{
    \textcolor{\l_ltximg_meta_brackcolor_tl}{#1}
}
\ExplSyntaxOff

% \pkgname{m}
\DeclareDocumentCommand\pkgname{m}{%
    \mbox{\textsf{\textcolor{SlateBlue}{#1}}}%
    \SortIndex{packages}{packages>\textsf{#1}}%
    %\SortIndex{#1}{\textsf{#1} (package)}%
}%

% \pkgopt{m}
\DeclareDocumentCommand\pkgopt{m}{%
    \mbox{\textsf{\textcolor{Orange}{#1}}}%
    \SortIndex{package options}{package options>\textsf{#1}}%
    \SortIndex{#1}{\textsf{#1} (package option)}%
}%

% \prgname{sm} : #1 index compiler, #2 index programs:
\DeclareDocumentCommand\prgname{sm}{%
    \IfBooleanTF{#1}
    {
    \mbox{\textcolor{ForestGreen}{\ttfamily\small\bfseries{#2}}\xspace}%
    \SortIndex{compiler}{compiler>\textsf{#2}}%
    }
    {
    \mbox{\textcolor{ForestGreen}{\ttfamily\small\bfseries{#2}}\xspace}%
    \SortIndex{programs}{programs>\textsf{#2}}%
    }
}%

% \prgopt{sm} : #1 compiler opt, #2 program opt:
\DeclareDocumentCommand\prgopt{sm}{%
    \IfBooleanTF{#1}
    {
    \mbox{\textcolor{gray}{\ttfamily\small\bfseries{-{}#2}}\xspace}%
    \SortIndex{compiler options}{compiler options>\small\texttt{-{}#2}}%
    }
    {
    \mbox{\texttt{-{}#2}}%
    \SortIndex{#2}{\texttt{-{}#2} (program option)}%
    }
}

% \scriptname{m}
\DeclareDocumentCommand\scriptname{m}{%
    %\mbox{\textsf{#1}}% 
    \textcolor{ForestGreen}{\ttfamily\small\bfseries{#1}}\xspace%
    \SortIndex{scripts}{scripts>\textsf{#1}}%
}%

% \scriptopt{m}
\DeclareDocumentCommand\scriptopt{m}{%
    \mbox{\texttt{#1}}\xspace%
    \SortIndex{script option}{script options>\small\textsf{#1}}%
}

% file extention
\DeclareDocumentCommand\fext{m}{%
    \mbox{\textcolor{optcolor}{\ttfamily\small\bfseries{.#1}}\xspace}%
    \SortIndex{files extention}{files extentions>\small\textsf{.#1}}%
}

% image format/extention
\DeclareDocumentCommand\iext{m}{%
    \mbox{\textcolor{optcolor}{\ttfamily\small\bfseries{#1}}\xspace}%
    \SortIndex{image format}{image formats>\small\textsf{#1}}%
}

% \sysydir{m}
\DeclareDocumentCommand\sysdir{m}{%
    \mbox{\textcolor{OrangeRed}{\ttfamily\small\bfseries{/#1}}}%
}

% \env{sm}, #1 not used now
\DeclareDocumentCommand\env{sm}{
    \textcolor{optcolor}{\ttfamily\small\bfseries{#2}}%
    \SortIndex{environment}{environments>\small\textsf{#2}}%
}

% \ics{sm}, #1 not used now
\DeclareDocumentCommand\ics{sm}{
    \textcolor{optcolor}{\ttfamily\small\bfseries{\textbackslash#2}}%
    \SortIndex{#2}{\textsf{\small\textbackslash#2}}
}

% \cmdopt[short]{long}
\NewDocumentCommand\cmdopt{om}{%
    \IfNoValueTF{#1}%
    {\textcolor{optcolor}{\ttfamily\small\bfseries{-\/-#2}}\xspace}%
    {\textcolor{optcolor}{\ttfamily\small\bfseries{-{}#1}}, \textcolor{optcolor}{\ttfamily\small\bfseries{-\/-#2}}\xspace}%
\SortIndex{options}{\textsf{\myscript}\ options in command line>\small\texttt{-\/-#2}}%
}

% \myenv{environ}
\DeclareDocumentCommand\myenv{m}{%
\moveright 0.0pt \hbox{%
    \begin{minipage}[t]{\marginparwidth}%
        \raggedleft\ttfamily\small%
        {\textcolor{gray}{\textbackslash begin\{}}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{\}}\par%
        \meta[ac=gray,cf=gray]{env content}\par%
        {\textcolor{gray}{\textbackslash end\{}}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{\}}%
    \end{minipage}%
                    } % close hbox
\SortIndex{environment}{environments>\small\textsf{#1}}%
}%

% \mytag{dtxtag}
\DeclareDocumentCommand\mytag{m}{%
\moveright 0.0pt \hbox{%
    \begin{minipage}[t]{\marginparwidth}%
        \raggedleft\ttfamily\small%
        \textcolor{gray}{\%<*}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{>}\par%
        \meta[ac=gray,cf=gray]{content}\par%
        \textcolor{gray}{\%</}{\bfseries\textcolor{optcolor}{#1}}\textcolor{gray}{>}%
    \end{minipage}%
                    } % close hbox
\SortIndex{docstrip}{docstrip tag>\textsf{#1}}%
}%

% \DescribeTE{sm}, #1 tag, #2 env
\newsavebox{\marginenvtag}
\NewDocumentCommand\DescribeTE{sm}{%
\begin{lrbox}{\marginenvtag}%
   \begin{minipage}[t]{\marginparwidth}%
    \raggedleft
    \IfBooleanTF{#1}{\mytag{#2}}{\myenv{#2}}
    \end{minipage}%
\end{lrbox}%
    \leavevmode%
    \marginpar{\usebox{\marginenvtag}}%
    \ignorespaces%
}%

% DescribeOptFile*{options}{example}[!]
\newsavebox{\optinfile}
\NewDocumentCommand\DescribeOptFile{s m m O{\hphantom{!}}}{
\begin{lrbox}{\optinfile}%
   \begin{minipage}[t]{\marginparwidth}%
        \raggedleft\ttfamily\bfseries%
        \textcolor{optcolor}{\%{#4}\myscript\hspace*{1.5pt}}%
    \end{minipage}%
\end{lrbox}%
\leavevmode%
\marginpar{\usebox{\optinfile}}%
\lapbox[0pt]{-0.85\marginparsep}{\textcolor{red}{\texttt{:}}}%
\textcolor{optcolor}{\bfseries\texttt{{#2}}}%
\textcolor{red}{\hspace*{2.5pt}\texttt{:}}
\hspace*{-1pt}\marg[cbc=optcolor,ac=gray,cf=gray]{#3}
\vspace*{2pt}\par%
\IfNoValueTF{#1}
{}%%
{%
\SortIndex{options}{\textsf{\myscript}\ options in input file>\small\texttt{#2}}%
}%
}

% \DescribeCmd[...]{...}{...}{...}, need changue to \DescribeOptCmd
\newsavebox{\optcmdline}
\NewDocumentCommand\DescribeCmd{ommm}{
\begin{lrbox}{\optcmdline}%
   \begin{minipage}[t]{\marginparwidth}%
    \ttfamily\bfseries\raggedleft%
    \IfNoValueTF{#1}
    {\textcolor{optcolor}{-\/-#2}}
    {\textcolor{optcolor}{-{#1}}\textcolor{gray}{,} \textcolor{optcolor}{-\/-#2}}%
    \end{minipage}%
\SortIndex{options}{\textsf{\myscript}\ options in command line>\small\texttt{-\/-#2}}%
\end{lrbox}%
    \leavevmode%
    \marginpar{\usebox{\optcmdline}}%
    \ignorespaces
    \meta[ac=gray,cf=gray]{\textnormal{\sffamily{#3}}}
    \hfill\textcolor{gray}{\textsf{(default: {#4})}}%
    \vspace*{2pt}\par%
}

% Create a language for documentation
\lstdefinelanguage{ltximg-doc}{
    texcsstyle=*,%
    escapechar=`,%
    showstringspaces=false,%
    extendedchars=true, %
    stringstyle = {\color{red}},%
% comments
    morecomment=[l]{\%},%
    commentstyle=\itshape\color{lightgray},%
% Important words 1
    keywordstyle=[1]{\bfseries\color{blue}},% 
    keywords=[1]{AtBeginDocument,begin,end,documentclass,BEGIN,END},%
% Other words 1
    keywordstyle=[2]{\color{blue!75}},% 
    keywords=[2]{usepackage,graphicspath,RequirePackage,renewcommand,%
    PreviewBbAdjust,usetikzlibrary,tikzexternalize,psset,tikzset,%
    DefineShortVerb,lstMakeShortInline,MakeSpecialShortVerb,UndefineShortVerb},%
% Other words 2
    keywordstyle=[3]{\color{optcolor!85}},%
    keywords=[3]{document,graphicx,preview,active,tightpage,article,%
    external,tikz,clean,pst,tkz,eps,pdf,xetex,latex,luatex,dvips,png,srcenv},%
% Reserved words 3(inputfile options)
    keywordstyle=[4]{\bfseries\color{optcolor}},% 
    keywords=[4]{ltximg,noltximg,remove,options,pspicture,endpspicture,%
    PSTexample,pgfpicture, endpgfpicture, tikzpicture, endtikzpicture, %
    psgraph, endpsgraph,nopreview,postscript, arara,extrenv,deltenv},%     
}[keywords,tex,comments,strings]% end languaje

% \begin{examplecode}[optlst]...\end{examplecode}
\lstnewenvironment{examplecode}[1][]{%
\lstset{
    language=ltximg-doc,%
    stringstyle = {\color{red}},%
    basicstyle=\ttfamily\small,%
    numbersep=1em,%
    numberstyle=\tiny\color{lightgray}\noaccsupp,%
% literateee
literate=*{\{}{{\bfseries\textcolor{gray}{\{}}}{1}
          {\}}{{\bfseries\textcolor{gray}{\}}}}{1}
          {[}{{\bfseries\textcolor{optcolor}{[}}}{1}
          {]}{{\bfseries\textcolor{optcolor}{]}}}{1}
          {*}{{\bfseries\textcolor{red}{*}}}{1}
          {:}{{\textcolor{red}{:}}}{1}
          {"}{{\textcolor{red}{\textquotedbl}}}{1}
          {,}{{\textcolor{gray}{,}}}{1}
          {=}{{\textcolor{gray}{=}}}{1}
          {/}{{\textcolor{gray}{/}}}{1}
          {\%\ ltximg}{{\textcolor{gray}{\%}\space\bfseries\textcolor{optcolor}{ltximg}}}{8}
          {\%\ arara}{{\textcolor{gray}{\%}\space\bfseries\textcolor{optcolor}{arara}}}{7}
          {\{arara}{{\textcolor{gray}{\{arara}}}{6}
          {\%<*remove>}{{\bfseries\textcolor{gray}{\%<*remove>}}}{10}
          {\%</remove>}{{\bfseries\textcolor{gray}{\%</remove>}}}{10}
          {\%<*ltximg>}{{\bfseries\textcolor{gray}{\%<*ltximg>}}}{10}
          {\%</ltximg>}{{\bfseries\textcolor{gray}{\%</ltximg>}}}{10}
          {\%<*noltximg>}{{\bfseries\textcolor{gray}{\%<*noltximg>}}}{12}
          {\%</noltximg>}{{\bfseries\textcolor{gray}{\%</noltximg>}}}{12},%
          #1,%
    }% close lstset
}%
{}% close examplecode

% \begin{examplecmd}...\end{examplecmd}
\lstnewenvironment{examplecmd}{%
\lstset{
    language=ltximg-doc,%
    basicstyle=\ttfamily\small,%
    frame=single,%
    rulecolor=\color{gray!50},%
    framesep=\fboxsep,%
    framerule=\fboxrule,%
    xleftmargin=\dimexpr\fboxsep+\fboxrule\relax,%
    xrightmargin=\dimexpr\fboxsep+\fboxrule\relax,%
% Reserved words (cmd line options)
    classoffset=4,%
    keywordstyle=\bfseries\color{optcolor},% 
    morekeywords={ltximg},%
% Only for command line options
    classoffset=5,%
    keywordstyle=\color{blue},% 
    keywords={user,machine},%
% literateee
literate=*{[}{{\textcolor{darkgray}{[}}}{1}
          {]}{{\textcolor{darkgray}{]}}}{1}
          {@}{{\textcolor{blue}{@}}}{1}
          {\$}{{\textcolor{blue}{\$}}}{1}
          {:}{{\textcolor{blue}{:}}}{1}
          {§}{{\textcolor{blue}{\$}}}{1}
          {~}{{\textcolor{blue}{\bfseries\textasciitilde}}}{1}%
    }% close lstset {~}
}%
{}% close examplecmd

% \lstinline[style=inline]|...|
\lstdefinestyle{inline}
{
    language=ltximg-doc,%
    basicstyle=\ttfamily\small\color{gray},%
% literateee
literate=*{\%}{{\bfseries\textcolor{gray}{\%}}}{1}
          %{\%</remove>}{{\bfseries\textcolor{gray}{\%</remove>}}}{10}
          %{\%<*ltximg>}{{\bfseries\textcolor{gray}{\%<*ltximg>}}}{10}
          %{\%</ltximg>}{{\bfseries\textcolor{gray}{\%</ltximg>}}}{10}
          %{\%<*noltximg>}{{\bfseries\textcolor{gray}{\%<*noltximg>}}}{12}
          %{\%</noltximg>}{{\bfseries\textcolor{gray}{\%</noltximg>}}}{12},%
}
\endinput
